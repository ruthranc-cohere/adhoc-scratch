<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   MCG Health Client Log In
  </title>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <link href="/bundles/toastrStyles.css" rel="stylesheet"/>
  <link href="/bundles/font-awesome.css" rel="stylesheet"/>
  <link href="/bundles/bootstrapAnimate.css" rel="stylesheet"/>
  <link href="/bundles/style.min.css?v=Z2XSr4vK49BUUGBwGYSb6aHKXBNIKED1x_zV3rimN8g" rel="stylesheet"/>
  <link href="/bundles/mcgStyle.min.css" rel="stylesheet"/>
  <link href="/css/508compliancestyle.css" rel="stylesheet"/>
 </head>
 <body>
  <div>
   <main>
    <div class="passwordBox login-form login-form-with-header">
     <div>
      <img alt="Welcoming Medical Practitioner" class="center-block img-responsive" src="/images/MCGCarewebLogin.png"/>
     </div>
     <div id="login" style="visibility: visible">
      <form action="/Account/Login?ReturnUrl=%2Fconnect%2Fauthorize%2Fcallback%3Fstate%3D610daefe766b374f03447373dd2eea40%26scope%3Dopenid%2520profile%26redirect_uri%3Dhttps%253A%252F%252Fcgi.careguidelines.com%252Fscripts%252Flogin_form.pl%26client_id%3Dcareweb%26response_type%3Dcode" class="m-t login" method="post" role="form">
       <input id="ReturnUrl" name="ReturnUrl" type="hidden" value="/connect/authorize/callback?state=610daefe766b374f03447373dd2eea40&amp;scope=openid%20profile&amp;redirect_uri=https%3A%2F%2Fcgi.careguidelines.com%2Fscripts%2Flogin_form.pl&amp;client_id=careweb&amp;response_type=code"/>
       <input id="ClientId" name="ClientId" type="hidden" value="careweb"/>
       <input data-val="true" data-val-required="The UseAdfs field is required." id="UseAdfs" name="UseAdfs" type="hidden" value="False"/>
       <p class="centerText">
        This is a client-only area of the website. Existing clients may enter their User ID and Password in the boxes below to access licensed solutions and other content.
       </p>
       <div class="text-danger validation-summary-valid" data-valmsg-summary="true">
        <ul>
         <li style="display:none">
         </li>
        </ul>
       </div>
       <div class="form-group">
        <label for="Email" id="emailLabel">
         Email
        </label>
        <div>
         <input autocomplete="off" class="form-control login-input" data-val="true" data-val-required="The Email field is required." id="Email" name="Email" placeholder="User ID" required="required" type="text" value=""/>
        </div>
       </div>
       <div class="form-group">
        <label for="Password" id="passwordLabel">
         Password
        </label>
        <div>
         <input autocomplete="off" class="form-control login-input" data-val="true" data-val-required="The Password field is required." id="Password" name="Password" placeholder="Password" required="required" type="password"/>
        </div>
       </div>
       <button class="log-btn" id="standard-login-button" onclick="externalProviderCheck(event);" style="float: right" type="button">
        Login
       </button>
       <br/>
       <button class="log-btn" id="external-provider-login-button" onclick="initiateExternalProviderLogin();" style="float: right; margin-top: 10px; margin-bottom: 10px; background-color:#21a5b3; display: none;" type="button">
        External Provider Login
       </button>
       <br/>
       <br/>
       <hr/>
       <p align="center" class="login-help">
        <a class="darker-font" href="/Account/ForgotPassword">
         Forgot Password?
        </a>
       </p>
       <input name="__RequestVerificationToken" type="hidden" value="CfDJ8MZ_rCqb6b9BuLiXXhLI6myK42jk0RfIPN5ROhHJEIIXRzFEarOBxsi8BJBO7Vl7UNFEwaya5QxZNVn2BXWa1_uYD12NBYtFf5cum5TBZtaT-oovl_FAN-dLfslAfIBE1VN44fJvG7U7ftgPR6PV__o"/>
      </form>
     </div>
     <div class="passwordBox login-form" id="pleaseWait" style="visibility: hidden;">
      <label style="font-size: x-large">
       Redirecting to your authentication server, please wait...
      </label>
     </div>
    </div>
   </main>
   <footer>
    <div class="banner footer">
     MCG Health, LLC. Â© 2024
     <a class="darker-font" href="https://www.mcg.com/contact-us/">
      Contact Us
     </a>
     <a class="darker-font" href="https://www.mcg.com/privacy-policy/">
      Privacy Policy
     </a>
    </div>
   </footer>
  </div>
  <script src="/bundles/jquery.js">
  </script>
  <script src="/lib/bootstrap/js/bootstrap.min.js">
  </script>
  <script src="/bundles/toastr.js">
  </script>
  <script type="text/javascript">
   jQuery('#Email').on("keydown", function (e) {
            if (e.key === "Tab") {
                $('#Password').focus();
                return externalProviderCheck(event);
            }
        });

        jQuery('#Email').on("click", function () {
            jQuery('#Email').off("click");
            jQuery('#Email').off("keydown");
            jQuery('#Email').on("blur", externalProviderCheck);
        });

        function initiateExternalProviderLogin() {
            console.log("Called External Provider Login");

            // perform external provider redirect.
            window.location.replace(redirectUrl);
        }

        /**
         * Called On Page Load To Check For External Client Mappings.
         */

        let redirectUrl = "";

        $(function () {

            let urlParam = getParameterByName(window.location.search, 'returnurl');

            urlParamDecoded = decodeURIComponent(urlParam)

            let clientId = getParameterByName(urlParamDecoded, 'client_id');

            urlParam = encodeURI(urlParam);

            // update UI
            $('#Email').prop('disabled', true);
            $('#Password').prop('disabled', true);
            $('#external-provider-login-button').prop('disabled', true);

            const _animationTimeout = window.setTimeout(() => $('#external-provider-login-button').html('<div id="loading"></div>'), 1000);

            $.ajax({
                type: "get",
                url: 'GenerateExternalAuthRedirectUrlFromServiceProvider?serviceProvider=' + clientId + '&returnUrl=' + urlParam,
                success: function (response) {
                    // update UI
                    clearTimeout(_animationTimeout);
                    $('#Email').prop('disabled', false);
                    $('#Password').prop('disabled', false);
                    $('#external-provider-login-button').prop('disabled', false).html('External Provider Login');
                    $('#Email').focus();

                    if (response != undefined && response.trim().length > 0) {
                        if (response == "EXTERNAL_PROVIDER_ERROR") {
                            alert("The external login provider is not reachable. Cancelling login attempt.");
                        } else {
                            redirectUrl = response;
                            $('#external-provider-login-button').show();
                        }
                    }
                },
                error: function (response) {
                    // update UI
                    clearTimeout(_animationTimeout);
                    $('#Email').prop('disabled', false);
                    $('#Password').prop('disabled', false);
                    $('#external-provider-login-button').prop('disabled', false).html('External Provider Login');
                    $('#Email').focus();
                }
            });

        });

        /**
         * Called via Email onblur and Login button click.
         */
        function externalProviderCheck(event) {

            event.preventDefault(); // Allow external domain check to finish.

            let urlParam = getParameterByName(window.location.search, 'returnurl');

            urlParamDecoded = decodeURIComponent(urlParam)

            var clientId = getParameterByName(urlParamDecoded, 'client_id');

            urlParam = encodeURI(urlParam);

            // Fetch Email.

            let email = document.getElementById("Email").value;

            if (email.indexOf("@") > -1) {

                // update UI
                $('#Email').prop('disabled', true);
                $('#Password').prop('disabled', true);
                $('#standard-login-button').prop('disabled', true);

                const _animationTimeout = window.setTimeout(() => $('#standard-login-button').html('<div id="loading"></div>'), 1000);

                $.ajax({
                    type: "get",
                    url: 'GenerateExternalAuthRedirectUrlFromEmailDomain?email=' + email + '&serviceProvider=' + clientId + '&returnUrl=' + urlParam,
                    success: function (response) {
                        // update UI
                        clearTimeout(_animationTimeout);
                        $('#Email').prop('disabled', false);
                        $('#Password').prop('disabled', false);
                        $('#standard-login-button').prop('disabled', false).html('Login');
                        $('#Password').focus();

                        if (response != undefined && response.trim().length > 0) {
                            if (response == "EXTERNAL_PROVIDER_ERROR") {
                                alert("The external login provider is not reachable. Cancelling login attempt.");
                            } else {
                                var loginDiv = document.getElementById("login");
                                var pleaseWaitDiv = document.getElementById("pleaseWait");
                                loginDiv.style.visibility = "hidden";
                                pleaseWaitDiv.style.marginTop = "-250px";
                                pleaseWaitDiv.style.visibility = "visible";

                                // perform external provider redirect.
                                window.location.replace(response);
                            }
                        } else {
                            if (event.type == "click") {
                                document.forms[0].submit(); // No domain map and this was a form (button click) submission, submit the form.
                            }
                        }
                    },
                    error: function (response) {
                        // update UI
                        clearTimeout(_animationTimeout);
                        $('#Email').prop('disabled', false);
                        $('#Password').prop('disabled', false);
                        $('#standard-login-button').prop('disabled', false).html('Login');
                        $('#Password').focus();
                    }
                });
            } else {
                if (event.type == "click") {
                    document.forms[0].submit(); // Using standard username.
                }
            }
        }

        getParameterByName = function (url, name) {
            var results = new RegExp('[\?&]' + name + '=([^&#]*)', 'i').exec(url);
            if (results == null) {
                return null;
            }
            return decodeURI(results[1]) || 0;
        }
  </script>
 </body>
</html>
